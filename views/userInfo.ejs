<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title><%= user %></title>
	<style type="text/css">
		.main{
			position: absolute;
			margin:auto;
			width: 700px;
			height: 600px;
			left: 0px;
			right: 0px;
			top: 50px;
			box-shadow:2px 5px 12px #555,-1px -1px 3px #292929;
			background-color: #eee;
		}
		.left,.right{
			float: left;
			position: relative;
			height: 100%;
			background-color: #ccc;
			width: 240px;
			padding-left: 10px; 
			overflow: auto;
		}
		.right{
			background-color: #aaa;
			width: 440px;
		}
		li{
			margin-top: 10px;
			margin-left: 0px; 
			font-size: 20px;
		}
		li:hover{
			opacity: 0.6;
			color: #5b5b5b;
		}
		ul{
			list-style: none;
			padding-left: 15px;
		}
		form{
			padding-left: 30px;
		}
		#title1{
			padding-bottom: 0px;
			margin-bottom: 0px;
		}
		.small{
			padding-top: 0px;
			margin-top: 0px;
			text-align: right;
			font-size: 12px;
			color: #888;
			display: inline;
		}
		.link{
			text-decoration: none;
			cursor: pointer;
			color: red;
		}
		.link:hover{
			color: blue;
		}
		.smalltitle{
			text-align: right;
		}
		#img{
			width:320px;
			margin: 55px;
			display: none;
		}
		#img_loading{
			margin:100px 200px;
			display: none;
		}
		.active{
			background-color: #aaa;
		}
		#adddevice{
			position: absolute;
			bottom: 10px;
		}
		#device_id{
			width: 120px;
		}
		#action{
			position: absolute;
			bottom: 10px;
			text-align: right;
			width: 95%;
		}
		#pic,#rec{
			float: right;
		}
	</style>
</head>
<body>
	<div class="main">
		<div class="left">
			<h1 id="title1">我的设备</h1>
			<div class="smalltitle">
				<p class="small">当前用户:</p><p class="small"><%= user %></p><a class="small link" href="/logout">&nbsp退出&nbsp</a>
			</div>
			<ul id="my_device"></ul>
			<div id="adddevice">
				<lable>设备ID：</lable><input id="device_id" placeholder=""/><button id="add">添加</button>
			</div>
		</div>
		<div class="right">
			<h1>设备操作</h1>
			<p id="current_device">当前设备：</p>
			<p id="name_device">设备名称：<input id="device_name"><button id="modifyname">修改</button></p>
			<p id="status_device">状态：</p>
			<img id="img" src=""><br>
			<img id="img_loading" src="/images/loading.gif">
			<div id="action">
				<button id="pic">拍照</button><button id="rec">录像</button>
			</div>
		</div>
	</div>
	<script src="\javascripts\jquery-1.10.2.min.js"></script>
	<script src="\socket.io\socket.io.js"></script>
	<script type="text/javascript">

		var reg = /:\/\/[^\/]+\//g,
			url = location.href;

		var user = $('title')[0].innerHTML;

		url = url.indexOf('http://') == -1 ? 'http://' + url : url;
		url = url.match(reg)[0].replace('://','').replace('/','');

		var socket = io.connect(url);
		// var socket = io.connect('http://115.29.179.7');

		socket.emit('init', { user_id:user});

		socket.on('data',function(data){
			$('#img_loading').hide();
			$('#img')[0].src = data;
			$('#img').show();
		})

		socket.on('device',function(data){

			var tag = $('#' + data.device_id)[0];
			var $tag = $('#' + data.device_id);

			if(data.state == 'on') {
				$tag.css('color','blue');
				$tag.html(data.device_id + '(在线)');
				tag.setAttribute('OnOff','在线');
			} else if(data.state == 'off') {
				$tag.css('color','black');
				$tag.html(data.device_id + '(离线)');
				tag.setAttribute('OnOff','离线');
			}

		})

		$('#my_device').click(function(e){
			if(e.target.tagName === 'LI'){
				if($('.active')[0])	$('.active')[0].classList.remove('active');
				e.target.classList.add('active');
				$('#current_device')[0].innerHTML = '当前设备：' + e.target.id;
				$('#device_name')[0].value = e.target.getAttribute('device_name');
				$('#status_device')[0].innerHTML = '状态：' + e.target.getAttribute('OnOff');
			}
		})

		$('#pic').click(function(){
			if(!$('.active')[0]){
				alert('请选择设备！');
				return;
			}

			if($('.active')[0].style.color !== 'blue'){
				alert('当前设备为离线状态！');
				return;
			}
			$('#img').hide();
			$('#img_loading').show();
			socket.emit('oparation', {from:user,to:$('.active')[0].id,cmd:0x01});
		})

		$('#rec').click(function(){
			if(!$('.active')[0]){
				alert('请选择设备！');
				return;
			}

			if($('.active')[0].style.color !== 'blue'){
				alert('当前设备为离线状态！');
				return;
			}
			$('#img').hide();
			$('#img_loading').show();
			socket.emit('oparation', {from:user,to:$('.active')[0].id,cmd:0x10});
		})

		$('#add').click(function(){
			var device_id = document.getElementById('device_id').value;

			if(!device_id){
				alert('请填写设备号');
			}

			$.post('/addDevice',{'device_id':device_id},function(data){
				console.log(data);
				if(data != 'ok') {
					alert(data);
					return;
				} else {
					location.href = location.href;
				}
				// var new_device=document.createElement('li');
				// new_device.id = device_id;
				// $(new_device).text(device_id + '(离线)');
				// document.getElementById('my_device').appendChild(new_device);
			})
		})

		$('#modifyname').on('click',function(){
			var name = $('#device_name')[0].value;
			$.post('/modifydevicename',{'name':name,'device_id':$('.active')[0].id},function(data){
				console.log(data);
				if(data == 'ok'){
					location.href = location.href;
				}
			})
		})

		$.get('/devices',function(data){
			for(var i=0;i<data.length;i++){
				var li = document.createElement('li');
				li.id = data[i].id_device;
				li.innerHTML = data[i].display_name + '(离线)';
				document.getElementById('my_device').appendChild(li);
				li.setAttribute('device_name',data[i].display_name);
				li.setAttribute('OnOff','离线');
			}
			$($('#my_device')[0].children[0]).click();
		})
	</script>
</body>
</html>